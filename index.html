<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel - Frota (GViz)</title>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
:root{
  --bg:#071029;
  --card:#2a71e8;
  --muted:#f7f9fa;
  --accent:#00eaff;
  --x:#c9d8f2;
}

html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:Inter,Arial;
}

header{
  /*display:flex;*/
  /*justify-content:space-between;*/
  align-items:center;
  padding:12px 20px;
  background:#020617;
}

header img{height:66px}
header .title{font-size:20px;font-weight:700;color:var(--accent)}
header .clock{font-size:20px;color:var(--muted)}

main{
  padding:12px;
  display:grid;
  grid-template-rows:1fr 1fr 1fr;
  gap:12px;
  height:calc(100vh - 92px);
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:12px;
  overflow:auto;
}

.card h2{
  margin:1 1 8px;
  color:var(--accent);
  font-size:20px;
  text-align:center;
}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:10;
  table-layout:fixed;
  font-size:24px
}

th, td{
  box-sizing:border-box;
  padding:12px 16px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  font-weight:700;
}

thead th{
  position:sticky;
  top:1;
  z-index:10;
  background:#0435bf;
}

thead th:first-child{border-top-left-radius:12px}
thead th:last-child{border-top-right-radius:12px}

/* larguras */
.w-data{width:100px text-align:left;}
.w-hora{width:100px text-align:left;}
.w-veiculo{width:200px text-align:left;}
.w-empregado{width:250px text-align:left;}
.w-passageiro{width:120px text-align:left;}
.w-periodo{width:250px text-align:left;}
.w-setor{width:120px text-align:left;}
.w-motivo{width:350px text-align:left;}
.w-itinerario{width:350px text-align:left;}
.w-status{width:220px;text-align:center text-align:left;}
.w-auto{width:auto}

/* mantém tabela limpa quando vazia */
table tbody:empty{
  display:block;
  min-height:120px;
}

/* status */
td.status-icon{text-align:center}
tr.status-atendido{background:rgba(147,219,112,.18)}
tr.status-andamento{background:rgba(219,147,112,.18)}
tr.status-concluido{background:rgba(0,200,120,.06)}
tr.status-cancelado{background:rgba(255,0,0,.12)}

.small{
  font-size:12px;
  color:var(--muted);
  text-align:center;
  margin-top:6px;
}
</style>
</head>

<body>

<header>
  <img src="logo.png" onerror="this.style.display='none'">
  <div class="title">MOVIMENTAÇÃO DIÁRIA</div>
  <div class="clock" id="clock"></div>
</header>

<main>
  <section class="card">
    <h2>PAINEL</h2>
    <div id="painel"></div>
  </section>

  <section class="card">
    <h2>AGENDA DO DIA</h2>
    <div id="agenda"></div>
  </section>

  <section class="card">
    <h2>AGENDA SERVIÇO SOCIAL</h2>
    <div id="social"></div>
  </section>
</main>

<div class="small">Atualização automática a cada 60s • Google Sheets</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E";
const TAB_PAINEL = "PAINEL";
const TAB_AGENDA = "AGENDA DO DIA";
const TAB_SS = "AGENDA SERVIÇO SOCIAL";

/* regras específicas por tabela */
const tableColumnRules = {
  painel: [
    { match:/data/i, cls:"w-data" },
    { match:/hora/i, cls:"w-hora" },
    { match:/ve[ií]culo/i, cls:"w-veiculo" },
    { match:/empregado/i, cls:"w-empregado" },
    { match:/itinerario/i, cls:"w-itinerario" },
    { match:/status/i, cls:"w-status" }
  ],
  agenda: [
    { match:/data/i, cls:"w-data" },
    { match:/hora/i, cls:"w-hora" },
    { match:/passageiro/i, cls:"w-passageiro" },
    { match:/setor/i, cls:"w-setor" },
    { match:/itinerario/i, cls:"w-itinerario" },
    { match:/status/i, cls:"w-status" }
  ],
  social: [
    { match:/data/i, cls:"w-data" },
    { match:/per[ií]odo/i, cls:"w-periodo" },
    { match:/passageiro/i, cls:"w-passageiro" },
    { match:/motivo/i, cls:"w-motivo" },
    { match:/itinerario/i, cls:"w-itinerario" },
    { match:/status/i, cls:"w-status" }
  ]
};

function resolveColumnClass(tableId, header){
  const rules = tableColumnRules[tableId] || [];
  const rule = rules.find(r => r.match.test(header));
  return rule ? rule.cls : "w-auto";
}

/* ================= CLOCK ================= */
function updateClock(){
  const n=new Date();
  clock.innerText =
    n.toLocaleDateString("pt-BR")+" — "+n.toLocaleTimeString("pt-BR");
}
setInterval(updateClock,1000); updateClock();

/* ================= HELPERS ================= */
const parseGvizText=t=>JSON.parse(t.substring(t.indexOf("{"),t.lastIndexOf("}")+1));
const escapeHtml=s=>String(s??"").replace(/[&<>]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;" }[m]));
const formatCell=c=>{
  if(!c) return "";
  if(typeof c==="object") return c.f ?? formatCell(c.v);
  return String(c);
};

/* ================= RENDER ================= */
function renderTable(containerId,g){
  const el=document.getElementById(containerId);
  const cols=g?.table?.cols?.map(c=>c.label||"")||[];
  const rows=g?.table?.rows||[];

  const colClasses=cols.map(h=>resolveColumnClass(containerId,h));

  let html="<table><thead><tr>";
  cols.forEach((h,i)=>html+=`<th class="${colClasses[i]}">${escapeHtml(h)}</th>`);
  html+="</tr></thead><tbody>";

  rows.forEach(r=>{
    const cells=r.c||[];
    const status=String(cells.at(-1)?.f??cells.at(-1)?.v??"").toLowerCase();
    let rowCls="";
    if(status.includes("cancelado")) rowCls="status-cancelado";
    else if(status.includes("concluido")) rowCls="status-concluido";
    else if(status.includes("andamento")) rowCls="status-andamento";
    else if(status.includes("atendido")) rowCls="status-atendido";

    html+=`<tr class="${rowCls}">`;
    cols.forEach((_,i)=>html+=`<td class="${colClasses[i]}">${escapeHtml(formatCell(cells[i]))}</td>`);
    html+="</tr>";
  });

  el.innerHTML=html+"</tbody></table>";
}

/* ================= LOAD ================= */
async function fetchSheet(tab){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(tab)}&tqx=out:json&nocache=${Date.now()}`;
  const r=await fetch(url,{cache:"no-store"});
  return parseGvizText(await r.text());
}

async function loadAll(){
  const [p,a,s]=await Promise.all([
    fetchSheet(TAB_PAINEL),
    fetchSheet(TAB_AGENDA),
    fetchSheet(TAB_SS)
  ]);
  renderTable("painel",p);
  renderTable("agenda",a);
  renderTable("social",s);
}

loadAll();
setInterval(loadAll,60000);
</script>

</body>
</html>
